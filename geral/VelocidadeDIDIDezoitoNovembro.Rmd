---
title: ""
output:
  html_document:
    df_print: paged
---
<style type="text/css">
      .main-container {
        max-width: 1800px;
        margin-left: auto;
        margin-right: auto;
      }
      .figure img{
      border-style: dotted !important;
      border-color:#333 !important;
      }
      </style>    
```{r pressure, echo=FALSE, fig.cap="", out.width = '100%'}
knitr::include_graphics("CabecalhoEstudoTecnico.jpg")
```

# <span style="text-decoration: underline">Velocidades Região R. 18 de Novembro - Setembro 2019 </span>  


```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.width=9.5, fig.align='center'}
library(jsonlite)
library(dplyr)
library(tidyr)
library(sp)
library(mapview)

inicio = "16/09/2019"
fim = "20/09/2019"

```

#### Os traçados representam filas de lentidão baseadas na localização e velocidade dos usuários do Waze.  
#### O Waze gera informações de congestionamento de tráfego processando as seguintes fontes de dados: 
#### ● Pontos de localização GPS enviados pelos telefones dos usuários (usuários que dirigem enquanto usam o aplicativo) e cálculos da velocidade real vs. velocidade média (no intervalo de tempo específico) e velocidade livre de fluxo (velocidade máxima medida no segmento da via). 
#### ● Os dados de velocidade média por trecho são dados pela Velocidade média atual em segmentos congestionados em metros/segundos.

```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.width=9.5, fig.align='center'}
load("congestionamentos_pico_manha_setembro_2019.Rda")
#nonoai = congestionamentos[congestionamentos$street =="R. Anita Garibaldi",]
#nonoai  = nonoai[complete.cases(nonoai$street),]
#congestionamentos = rbind(nonoai)

```


### Mapa de Velocidades praticadas em períodos congestionados no pico da manhã no período de setembro de 2019:
```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.width=9.5, fig.align='center'}
congestionamentos = congestionamentos[congestionamentos$pubMillis > "2019-09-15",]
congestionamentos = congestionamentos[congestionamentos$pubMillis < "2019-09-21",]
congestionamentos$hora = as.numeric(substr(congestionamentos$pubMillis, 12,13))
congestionamentos = congestionamentos[congestionamentos$hora > 06,]
congestionamentos = congestionamentos[congestionamentos$street %in% "R. 18 de Novembro", ]
#View(cavalhada)

lista = list()
nomes_linhas = list()
for (i in 1:length(congestionamentos$country)) {
  nomes_linhas[i] = i
  teste = congestionamentos$line[i]
  teste = as.data.frame(teste)
  l1 = cbind(c(teste$x),c(teste$y))
  Sl1 = Line(l1)
  S1 = Lines(list(Sl1), ID=i)
  lista[i] = S1
}

Sl = SpatialLines(lista)
proj4string(Sl) <- CRS("+init=epsg:4326")
row.names(congestionamentos) = row.names(Sl)
SlDF <- SpatialLinesDataFrame(Sl, data = congestionamentos[,c(1:3, 5:16)])

paletta = colorRampPalette(c("#ff0000","#cc0099", "orange", "yellow", "green", "blue"), space="Lab" )
mapview(SlDF, zcol= 'speedKMH', color = paletta, layer.name = 'Velocidade Verificada por Trecho - Pico da Manhã', lwd=4,
        legend = TRUE, map.types=c("OpenStreetMap", "CartoDB.DarkMatter", "Esri.WorldImagery", "Esri.WorldStreetMap"))

congestionamentos$velocidadeMediaEstimada = (congestionamentos$length / ((congestionamentos$length/congestionamentos$speed)-congestionamentos$delay) ) * 3.6


```


### Tabela de registros de alertas no pico da manhã no período de setembro de 2019:
```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.width=9.5, fig.align='center'}
frame = as.data.frame(congestionamentos)
#frame = frame[, c(15, 5, 11, 14, 16,18)]
#frame = frame[, c(14, 5, 10, 13, 15,18, 19)]
frame = frame[, c("street", "speedKMH", "length", "speed", "delay", "pubMillis", "hora", "velocidadeMediaEstimada")]
names(frame) = c("Via", "Velocidade_Verificada_Km_h", "Fila_em_metros","Vel. verificada m/s", "Atraso (segundos)", "Data",  "Hora", "Velocidade Media Estimada*")
frame$Hora = as.character(substr(frame$Data, 12,20))
#library(lubridate)
#frame$Data = with_tz(frame$Data, tzone = "America/Sao_Paulo")
#frame$Data =  paste(substr(frame$Data, 9,10), "/", substr(frame$Data, 6,7), "/", substr(frame$Data, 0,4), " ", substr(frame$Data, 12,19),sep = "")
frame = frame[frame$Data> "2019-09-01 00:00:00", ]
frame

library(xlsx)
write.xlsx(frame, file="analise_anita.xlsx", sheetName="Manha", 
  col.names=TRUE, row.names=FALSE, append=FALSE, showNA=TRUE, password=NULL)
```

#### * A velocidade média estimada no pico da manhã no período de setembro de 2019 foi de `r round(mean(frame$Velocidade_Verificada_Km_h[frame$Velocidade_Verificada_Km_h> 0]), digits = 2)` km/h (desconsiderando os eventos de fila parada).
#### * O tamanho médio de fila computado no pico da manhã no período de setembro de 2019 foi de `r round(mean(frame$Fila_em_metros[frame$Fila_em_metros> 0]), digits = 2)` metros.
#### * O atraso médio de fila computado no pico da tarde no período de setembro de 2019 foi de `r round(mean(congestionamentos$delay[congestionamentos$delay> 0]), digits = 2)`s.
#### * O numero de registro de filas noperíodo de setembro de 2019 foi de `r length(frame$Via)`

### * Velocidade Média Estimada: {(congestionamento_metros / ((congestionamento_metros/velocidade) - atraso)) * 3.6}.





### Fonte: Waze CCP.